"""Load saved model and provide a simple predict function."""
import os
import joblib
import pandas as pd
from typing import Dict, Any


def load_model(path: str):
    if not os.path.exists(path):
        raise FileNotFoundError(path)
    obj = joblib.load(path)
    return obj.get("model"), obj.get("scaler"), obj.get("columns")


def predict_from_reading(model, scaler, columns: list, reading: Dict[str, Any]):
    """reading: dict with keys hour, latitude, longitude, city (optional)

    Returns predicted pollutant value (float).
    """
    row = pd.DataFrame([reading])

    # Minimal preprocessing similar to training
    X_pred = row[["hour", "latitude", "longitude"]].copy()
    if "city" in row.columns:
        X_pred["city"] = row["city"].fillna("unknown")
        X_pred = pd.get_dummies(X_pred, columns=["city"])

    # Align columns with the training data
    missing_cols = set(columns) - set(X_pred.columns)
    for c in sorted(list(missing_cols)): # sorted for deterministic order
        X_pred[c] = 0
    X_pred = X_pred[columns] # Ensure the order of columns is the same

    # Scale numeric columns if a scaler is available
    if scaler is not None:
        num_cols = [c for c in X_pred.columns if X_pred[c].dtype.kind in "biufc" and c in scaler.feature_names_in_]
        if num_cols:
            X_pred[num_cols] = scaler.transform(X_pred[num_cols])

    pred = model.predict(X_pred)
    return float(pred[0])
